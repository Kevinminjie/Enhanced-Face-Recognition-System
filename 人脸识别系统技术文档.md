# 人脸识别系统技术文档

## 项目概述

本项目是一个集成了人脸识别、语音识别、数据库管理和硬件控制的智能工厂管理系统。系统主要用于工厂环境中的员工身份识别、工作流程记录和质量检验管理。

## 系统架构

### 1. 核心模块架构

```
人脸识别系统
├── 人脸识别模块 (FaceRecUI/)
│   ├── 核心识别引擎 (FaceRecognition.py)
│   ├── GUI界面 (FaceRecognition_UI.py)
│   └── 资源文件 (Font/, images_test/)
├── 语音识别模块 (main.py, gui_main.py)
│   ├── 讯飞语音API集成
│   ├── OpenAI语言模型处理
│   └── 实时语音转文本
├── 数据库模块
│   ├── MySQL数据库设计
│   ├── 员工工件信息表
│   └── 人脸特征数据库
├── 硬件控制模块 (control_ad.py)
│   ├── Arduino串口通信
│   ├── 音频录制控制
│   └── 摄像头控制
└── Web界面模块 (web_YY/)
    ├── Flask Web服务
    ├── 实时人脸检测
    └── 数据可视化
```

## 技术实现详解

### 2. 人脸识别模块

#### 2.1 技术栈
- **深度学习框架**: PyTorch + MTCNN
- **传统视觉库**: dlib + OpenCV
- **GUI框架**: PyQt5
- **图像处理**: PIL, numpy

#### 2.2 核心功能
- **人脸检测**: 使用MTCNN进行高精度人脸检测
- **特征提取**: dlib ResNet模型提取128维人脸特征向量
- **人脸识别**: 基于欧氏距离的相似度匹配
- **数据增强**: 镜像翻转、高斯模糊等增强技术

#### 2.3 关键代码实现
```python
# 模型加载
mtcnn = MTCNN(keep_all=True, device='cuda' if torch.cuda.is_available() else 'cpu')
predictor = dlib.shape_predictor('../data/data_dlib/shape_predictor_68_face_landmarks.dat')
reco_model = dlib.face_recognition_model_v1("../data/data_dlib/dlib_face_recognition_resnet_model_v1.dat")

# 数据增强
def augment_image(img):
    flip = cv2.flip(img, 1)  # 镜像
    blur = cv2.GaussianBlur(img, (5, 5), 0)  # 高斯模糊
    return [img, flip, blur]
```

### 3. 语音识别与自然语言处理

#### 3.1 技术架构
- **语音识别**: 讯飞语音识别API
- **自然语言处理**: OpenAI GPT模型
- **音频处理**: PyAudio + WebSocket
- **静音检测**: VAD (Voice Activity Detection)

#### 3.2 工作流程
1. **音频采集**: 实时采集麦克风音频数据
2. **静音检测**: 基于音频幅度的VAD算法
3. **语音识别**: WebSocket连接讯飞API进行实时转录
4. **语义理解**: OpenAI模型提取工件信息
5. **结构化输出**: JSON格式的工件数据

#### 3.3 关键参数配置
```python
# 音频参数
CHUNK = 1024
FORMAT = pyaudio.paInt16
CHANNELS = 1
RATE = 44100
SILENCE_THRESHOLD = 200
MAX_SILENCE_DURATION = 8

# 讯飞API配置
wsParam = Ws_Param(
    APPID='12d84f1e',
    APIKey='598d23f9a26a02b52a0a0ec9760298fd',
    APISecret='OGFmYTQ5YWRhNmZkNDM2ZWI4NWJlOGI3'
)
```

### 4. 数据库设计

#### 4.1 数据库架构
- **数据库**: MySQL 8.0
- **字符集**: utf8mb4
- **存储引擎**: InnoDB

#### 4.2 核心数据表

**员工工件信息表 (employee_workpiece)**
```sql
CREATE TABLE employee_workpiece (
    id INT AUTO_INCREMENT PRIMARY KEY,
    employee_id VARCHAR(20) NOT NULL COMMENT '员工编号',
    job_type ENUM('工人', '质检员') NOT NULL COMMENT '工种',
    workpiece_name VARCHAR(100) NOT NULL COMMENT '工件名称',
    workpiece_dn VARCHAR(50) NOT NULL COMMENT '工件图号',
    workpiece_size VARCHAR(100) NOT NULL COMMENT '工件尺寸',
    
    -- 工人专用字段
    start_time DATETIME NULL COMMENT '开工时间',
    process_type VARCHAR(50) NULL COMMENT '加工类型',
    self_check_result TEXT NULL COMMENT '自检结果',
    
    -- 质检员专用字段
    inspection_passed BOOLEAN NULL COMMENT '检验结果',
    inspection_details TEXT NULL COMMENT '检验详情',
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

**人脸特征数据库 (features_all.csv)**
- 存储格式: CSV文件
- 编码: GB2312
- 内容: 员工姓名 + 128维特征向量

#### 4.3 数据操作接口
```python
def insert_to_database(employee_id, job_type, workpiece_name, workpiece_dn, workpiece_size,
                       start_time=None, process_type=None, self_check_result=None,
                       inspection_passed=None, inspection_details=None):
    """统一的数据库插入接口"""
    connection = mysql.connector.connect(**DB_CONFIG)
    # 根据工种执行不同的插入逻辑
```

### 5. 硬件控制系统

#### 5.1 Arduino集成
- **通信协议**: 串口通信 (COM3, 9600波特率)
- **控制信号**: 
  - `X_AXIS_LIMIT_TRIGGERED`: 开始录音
  - `Z_AXIS_LIMIT_TRIGGERED`: 停止录音
- **手动控制**: 's'开始, 'q'停止, 'x'退出

#### 5.2 音频录制控制
```python
def start_recording():
    """开始录音"""
    global is_recording, audio, stream, frames
    audio = pyaudio.PyAudio()
    stream = audio.open(format=FORMAT, channels=CHANNELS, 
                       rate=RATE, input=True, frames_per_buffer=CHUNK)
    # 多线程录音实现

def stop_recording():
    """停止录音并保存"""
    # 保存为WAV格式
    wf = wave.open(WAVE_OUTPUT_FILENAME, 'wb')
    wf.writeframes(b''.join(frames))
```

#### 5.3 摄像头控制
- **设备**: USB摄像头 (设备ID: 0)
- **分辨率**: 640x480
- **帧率**: 30fps
- **实时显示**: OpenCV窗口显示

### 6. GUI管理界面

#### 6.1 主界面功能
- **实时人脸识别**: 摄像头画面 + 识别结果显示
- **人脸数据管理**: 录入、删除、修改员工信息
- **识别记录查看**: 历史识别记录表格显示
- **系统状态监控**: 设备状态、识别精度等

#### 6.2 界面组件
```python
class Face_MainWindow(Ui_MainWindow):
    def __init__(self, MainWindow):
        self.setupUi(MainWindow)  # 界面生成
        self.retranslateUi(MainWindow)  # 界面控件
        self.slot_init()  # 槽函数连接
        
        # 核心组件初始化
        self.detector = dlib.get_frontal_face_detector()
        self.predictor = dlib.shape_predictor('...')
        self.face_reco_model = dlib.face_recognition_model_v1('...')
```

### 7. Web服务模块

#### 7.1 Flask Web应用
- **实时人脸检测**: 基于OpenCV的Web摄像头
- **数据可视化**: 工件信息展示页面
- **API接口**: RESTful API提供数据服务

#### 7.2 模板页面
- `index.html`: 主页面
- `process.html`: 工人操作页面
- `supervise.html`: 质检员页面
- `results.html`: 结果展示页面

## 系统部署与配置

### 8. 环境要求

#### 8.1 硬件要求
- **CPU**: Intel i5以上或同等性能
- **内存**: 8GB以上
- **GPU**: NVIDIA GPU (支持CUDA, 可选)
- **摄像头**: USB摄像头
- **麦克风**: 音频输入设备
- **Arduino**: 硬件控制板

#### 8.2 软件环境
- **操作系统**: Windows 10/11
- **Python**: 3.8+
- **数据库**: MySQL 8.0
- **CUDA**: 11.0+ (GPU加速可选)

#### 8.3 依赖库
```
核心依赖:
- torch, torchvision (深度学习)
- opencv-python (计算机视觉)
- dlib (人脸识别)
- PyQt5 (GUI界面)
- mysql-connector-python (数据库)
- pyaudio (音频处理)
- websocket-client (语音识别)
- openai (自然语言处理)
- pyserial (串口通信)
- flask (Web服务)
```

### 9. 配置说明

#### 9.1 数据库配置
```python
DB_CONFIG = {
    'host': 'localhost',
    'database': 'factory_management',
    'user': 'root',
    'password': 'your_password',
    'charset': 'utf8mb4'
}
```

#### 9.2 API密钥配置
```python
# 讯飞语音API
APPID = 'your_appid'
APIKey = 'your_api_key'
APISecret = 'your_api_secret'

# OpenAI API
client = OpenAI(
    api_key="your_openai_key",
    base_url="https://api.deepseek.com"
)
```

#### 9.3 硬件配置
```python
# 串口配置
ser = serial.Serial('COM3', 9600, timeout=1)

# 摄像头配置
cap = cv2.VideoCapture(0)
cap.set(cv2.CAP_PROP_FRAME_WIDTH, 640)
cap.set(cv2.CAP_PROP_FRAME_HEIGHT, 480)
```

## 系统特色与创新点

### 10. 技术亮点

1. **多模态融合**: 人脸识别 + 语音识别的双重身份验证
2. **实时处理**: 基于多线程的实时音视频处理
3. **智能语义理解**: AI模型自动提取工件信息
4. **硬件集成**: Arduino控制的自动化录音触发
5. **灵活部署**: 支持桌面GUI和Web两种界面
6. **数据完整性**: 完整的工人-质检员工作流程记录

### 11. 应用场景

- **工厂车间**: 员工身份识别与工作记录
- **质量检验**: 质检员检验结果记录
- **生产管理**: 工件加工流程追踪
- **数据分析**: 生产效率与质量统计

## 维护与扩展

### 12. 系统维护

- **日志监控**: 详细的运行日志记录
- **错误处理**: 完善的异常捕获机制
- **数据备份**: 定期数据库备份策略
- **性能优化**: GPU加速与多线程优化

### 13. 扩展方向

- **移动端支持**: 开发移动APP版本
- **云端部署**: 支持云服务器部署
- **更多硬件**: 集成更多工业传感器
- **AI增强**: 更先进的深度学习模型

---

**文档版本**: v1.0  
**最后更新**: 2024年12月  
**技术负责人**: [您的姓名]  
**项目状态**: 开发完成，持续优化中